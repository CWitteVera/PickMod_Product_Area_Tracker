Project Instructions for GitHub Copilot — PickMod_Product_Area_Tracker

Context (Hardware, Toolchain, Versions)
- Board: Waveshare ESP32‑S3 Touch LCD 7", RGB 800×480 panel, capacitive touch GT911 on I²C. The board family uses a CH422G I/O expander on the I²C bus; on the 7" variant, GT911 reset (TP_RST) is routed to CH422G EXIO1, so you must toggle it via the expander before initializing the GT911 driver. The CH422G typically responds at I²C 0x24. [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)
- Firmware: ESP‑IDF 5.2.0 (keep examples and Kconfig aligned to this version to avoid timing/porting drift). [2](https://esphome.io/components/touchscreen/gt911/)
- Graphics: LVGL v8 (matches Waveshare and Espressif demo patterns for S3 + RGB and reduces porting friction). [3](https://www.haraldkreuzer.net/en/news/Using-Sunton-MaTouch-ESP32-S3-7-inch-displays-with-LVGL-and-ESP-IDF)[2](https://esphome.io/components/touchscreen/gt911/)
- UI Authoring: EEZ Studio on Windows; export LVGL 8.x code at 800×480 and integrate into firmware. LVGL major must match between EEZ export and firmware. [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)

Reference set for Copilot (follow these patterns exactly)
• Waveshare ESP32‑S3 7" board wiki (overview/demos/pinouts) [3](https://www.haraldkreuzer.net/en/news/Using-Sunton-MaTouch-ESP32-S3-7-inch-displays-with-LVGL-and-ESP-IDF)
• Espressif ESP32‑S3 LCD EV‑Board LVGL demo (RGB + LVGL direct‑mode, anti‑tearing, init sequence) [2](https://esphome.io/components/touchscreen/gt911/)
• EEZ Studio docs (LVGL project/export, version parity) [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)
• LVGL on ESP32 performance tips (buffer sizes, double buffering, CPU/IRAM) [5](https://community.home-assistant.io/t/esp32-s3-4-3inch-capacitive-touch-display-from-waveshare/658279?page=4)
• 7" Waveshare mapping used by the community: EXI01=TP_RST, EXI02=DISP, EXI03=LCD_RST, CH422G @ 0x24 (useful for touch reset & DISP gating) [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)

Goals
1) Screen bring‑up first (stability > features):
   - Solid RGB timing with no flicker, jump, or tearing.
   - LVGL v8 minimal label remains stable for ≥60 s (no “jumping text”).
   - Touch enabled only after pulsing GT911 reset via CH422G EXIO1. [2](https://esphome.io/components/touchscreen/gt911/)[5](https://community.home-assistant.io/t/esp32-s3-4-3inch-capacitive-touch-display-from-waveshare/658279?page=4)[1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)

2) EEZ integration second:
   - Import EEZ v8 export (800×480) and display a simple label → then implement Home and Setup screens. [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)

3) App scaffolding third:
   - Zones (3×3): L3_Z1, L3_Z2, L3_Z3; L2_Z3, L2_Z2, L2_Z1; L1_Z1, L1_Z2, L1_Z3.
   - Per‑zone thresholds (defaults Green 0–10, Yellow 11–25, Red 26–30).
   - Manual ± does not persist.
   - Data adapters: start with stub, later HTTP JSON from a PC server that polls ControlLogix tags + Lighting Pick SQL.

Repository Structure to Generate
main/
  app_main.c
  hal/
    display.c/.h        # esp_lcd RGB init (800×480), LVGL buffers, esp_lvgl_port (direct-mode)
    touch.c/.h          # CH422G helper (0x24), GT911 reset via EXIO1, GT911 init & LVGL indev
  app/
    zone_model.c/.h     # counts, per-zone thresholds, color mapping, manual ± (no persistence)
  net/
    data_adapter.h
    data_adapter_stub.c
    data_adapter_http.c # later
  ui/
    ui_init.c/.h        # glue for EEZ-exported UI
    ... (EEZ LVGL v8 export files)
sdkconfig.defaults
CMakeLists.txt
tools/eez_export_notes.md
tests/test_zone_model.cpp
README.md

Hard Requirements (do not skip)
1. Clone a known‑good demo sdkconfig & RGB timings from the Espressif S3 LCD EV‑Board LVGL demo; then change only serial port and essentials. Expect boot logs like “avoid lcd tearing effect” and “LVGL direct‑mode.” If missing, your init/Kconfig differs—match the demo. [2](https://esphome.io/components/touchscreen/gt911/)
2. LVGL v8 parity between firmware and EEZ export (no cross‑major mixing that leads to ABI/API mismatches). [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)
3. Single LVGL task + mutex discipline (lv_timer_handler() on its own task; lock around any cross‑task UI calls), as in the Espressif demo. [2](https://esphome.io/components/touchscreen/gt911/)
4. Pulse GT911 RST via CH422G before GT911 init:
   - I²C master to CH422G @ 0x24 → drive EXI01 (TP_RST) LOW ~10 ms → HIGH ~50 ms → then create the GT911 touch device and probe 0x5D then 0x14 for address. Do not init GT911 prior to this pulse. [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)
5. Performance knobs: CPU 240 MHz, PSRAM enabled, LVGL draw buffers per LVGL perf note; enable double buffering if memory allows to reduce tearing. [5](https://community.home-assistant.io/t/esp32-s3-4-3inch-capacitive-touch-display-from-waveshare/658279?page=4)

Milestone 1 — Panel‑Only Validation (no LVGL, no touch)
Tasks
- Implement hal/display.c using esp_lcd to set RGB 800×480; draw solid fills/color bars for ≥60 s.
- If any drift/tearing appears, copy EV‑Board porch/HSYNC/VSYNC/PCLK timings exactly and retest. [2](https://esphome.io/components/touchscreen/gt911/)
Exit Criteria
- No flicker, no jump, no garbled frames for ≥60 s.

Milestone 2 — LVGL v8 Minimal Label (no touch)
Tasks
- Add esp_lvgl_port (IDF style) and direct‑mode as in the EV‑Board demo; create a centered lv_label.
- Keep a single LVGL task; verify boot logs show anti‑tearing/direct‑mode. [2](https://esphome.io/components/touchscreen/gt911/)
Exit Criteria
- Label remains perfectly stable for ≥60 s under ESP‑IDF 5.2.0. [2](https://esphome.io/components/touchscreen/gt911/)

Milestone 3 — Touch Bring‑Up with CH422G Reset
Tasks
1. In hal/touch.c, implement a minimal CH422G helper that writes the EXIO output register and controls EXI01 (TP_RST). Mapping & default addr for this board family are documented (CH422G 0x24, EXI01=TP_RST, EXI02=DISP, EXI03=LCD_RST). [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)
2. On boot, pulse EXI01 LOW→HIGH (10 ms/50 ms) before creating the GT911 device.
3. Probe GT911 at 0x5D, otherwise 0x14; register LVGL indev.
4. Print (x,y) to serial for a few seconds (no LVGL) → then attach to LVGL.
5. Re‑confirm label stability (no “jumping” after touch is enabled).
Exit Criteria
- Touch reports correct coordinates; LVGL remains stable for ≥60 s.

Milestone 4 — EEZ Studio (LVGL v8) Integration
Tasks
- Create an EEZ LVGL 8.x project at 800×480 and export a single‑label screen first.
- Add ui/ui_init.c glue that calls the EEZ‑generated constructors after LVGL init.
- Once stable, expand to:
  - Home: 3×3 bars (one per zone) with count + color (G/Y/R) and up to 2 operator names.
  - Setup: per‑zone threshold editors (defaults G 0–10, Y 11–25, R 26–30), in/out tag LEDs, manual ± (no persistence). [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)
Exit Criteria
- EEZ UI renders; switching Home/Setup is smooth; bars and labels update from the stub adapter.

Application & Data Scaffolding
zone_model.h (sketch)
typedef struct {
  char  id[8];            // "L3_Z1" etc.
  int   count;
  int   green_max;        // inclusive: [0..g], [g+1..y], [y+1..r]
  int   yellow_max;
  int   red_max;
  char  operators[2][24]; // up to 2 operators
  bool  tag_in, tag_out;  // current states
  bool  last_in, last_out;// for rising-edge detection
} zone_t;

Rules
- Rising edge on tag_in → count++; rising edge on tag_out → count-- (clamp 0..red_max).
- Manual ± does not persist across reboot.

Adapters
- data_adapter_stub.c: simulate tag edges & sample operators.
- data_adapter_http.c: later, poll PC GET /zones JSON.

README & Menuconfig Notes to Generate
- Document menuconfig toggles mirroring the EV‑Board LVGL demo (anti‑tearing/direct‑mode) and LVGL perf recommendations (buffer sizing, PSRAM, 240 MHz). Include example boot logs for verification. [2](https://esphome.io/components/touchscreen/gt911/)[5](https://community.home-assistant.io/t/esp32-s3-4-3inch-capacitive-touch-display-from-waveshare/658279?page=4)
- Document EEZ export steps (LVGL v8, 800×480) and the requirement for version parity. [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)

Acceptance Criteria (per PR)
- Panel‑only: 60 s of clean fills/bars (no artifacts). [2](https://esphome.io/components/touchscreen/gt911/)
- LVGL label: 60 s stable; direct‑mode/anti‑tearing logs present. [2](https://esphome.io/components/touchscreen/gt911/)
- Touch: CH422G EXI01 reset performed; GT911 detected at 0x5D or 0x14; serial prints of touches; LVGL indev feeds events with no instability. [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)
- EEZ v8: minimal label renders, then Home/Setup render at 800×480 with per‑zone thresholds and manual ± working (no persistence). [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)

Known Pitfalls to Avoid
- Initializing GT911 before pulsing EXI01 → flaky/no touch and “jumping” UI. Always reset via CH422G first. [1](https://files.waveshare.com/wiki/ESP32-S3-Touch-LCD-7/Performance.pdf)
- Mixing LVGL majors (e.g., EEZ v9 export with LVGL v8 firmware) → crashes/odd behavior. Keep v8 ↔ v8. [4](https://www.waveshare.com/wiki/ESP32-S3-Touch-LCD-7)
- Starting from scratch Kconfig/timings → reintroduces tearing. Begin from the EV‑Board LVGL demo config, then tweak minimally. [2](https://esphome.io/components/touchscreen/gt911/)
